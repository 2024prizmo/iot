4.1. Лабораторная работа. Знакомимся с протоколом MQTT
=====================

4.1.1. Что такое MQTT и зачем он нужен?
-----------------------------------
В настоящий момент MQTT - один из двух самых распространенных протоколов прикладного уровня, используемых в Интернете вещей (второй протокол - это CoAP). Практически все известные облачные платформы IoT так или иначе имеют интерфейс MQTT.
Немного о самом протоколе и его истории. Он был разработан в 1999 году для систем транспортировки нефти: передачи данных от различных сенсоров в SCADA-систему в реальном времени. Его основные характеристики - простота, открытость, легковесность (не загружает канал связи). В те времена стоимость связи была гораздо выше, чем сейчас, и это предопределило особенности протокола MQTT.
Интересно, что изначально название протокола расшифровывалось как Message Queue Telemetry Transport. Однако это вносило путаницу, поскольку в MQTT используется другой паттерн: "Издатель/Подписчик" (Publisher/Subscriber), а не "Очередь сообщений" (Message Queue). Поэтому от расшифровки отказались, и на данный момент MQ в названии официально ничего не значит.
### MQTT в иерархии протоколов
Место протокола MQTT в сетевой модели TCP/IP находится на самом верхнем уровне, прикладном.
Важно, что в своей канонической реализации MQTT ниже уровнем предполагает использование TCP в качестве транспортного протокола. Это делает его несколько тяжелым для использования в сетях низкопотребляющих устройств, где важен каждый переданный байт. Существует реализация MQTT-SN для сенсорных сетей, в которой уровнем ниже находится UDP.
### Устройство MQTT
MQTT работает по модели "Издатель/подписчик", Что делает MQTT интересным для нас протоколом? Если говорить языком книги Эндрю Ханта и Дэвида Томаса "Программист-прагматик", он позволяет нам соблюдать принцип ортогональности, то есть строить программу как набор слабо связанных между собой сущностей.

4.1.2. Установка mosquitto
---------
На этом практикуме предстоит подробно изучить протокол MQTT. Для уверенной работы с ним стоит проделать несколько упражнений.
Сервер Mosquitto - лишь один из возможных вариантов сервера. Можно использовать и другие: HiveMQTT, HBMQTT. Но мы будем использовать Mosquitto, поскольку это самый популярный Open Source-сервер.
Установите себе на компьютер mosquitto. Это сервер, который можно запустить локально и потренироваться на нём. Установка на Ubuntu делается просто:
```C
sudo apt-get install mosquitto
```
Можно даже установить mosquitto в Windows, просто скачав дистрибутив с сайта. Тогда он появится в “Службах” Windows, и его можно будет запускать и останавливать из этого окна:
![1](https://lh5.googleusercontent.com/Iget6_rzvfryD_38-6zb5UqINhsG8mvArfuLGpo7n6mYX-kLB7_IMSoYpxw7xFjhwGIfrtlXkRpzO0SP45k_Mi9QmXmaFLxLqmjwYgk0TU7sSXsv7hDBRVnhIKbNYPIvZEhwx6ul)
После этого необходимо зайти в Командную строку Windows и прописать там:
```C
cd [абсолютный путь до папки с mosquitto]
```
После этого мы попадаем в папку с самой программой и для запуска сервера необходимо ввести:
```C
masquitto.exe -v
```
После этого возможны 2 варианта: 
1) Сервер запустится и начнет свою работу. 
2) Вам выдаст ошибку о закрытом порте
Во втором случае необходимо запустить сервер на другом порте:
```C
mosquitto.exe -v -p [номер порта]
```
Например:
```C
mosquitto.exe -v -p 1900
```

4.1.3. Hello World в mosquitto
------
### 1.Подписка на топик
В окне терминала введите команду подписки на топик:
```C
mosquitto.exe mosquitto_sub -h "localhost" -t "mytopic" -q 1
```
В качестве хоста указан localhost (то есть сам компьютер), а в качестве топика — вымышленный mytopic
Результат: программа будет ждать сообщений из этого топика.
### 2. Отправка сообщения
Наконец, в третьем окне терминала введите команду, отправляющую сообщение — mosquitto_pub:
```C
mosquitto.exe mosquitto_pub -h "localhost" -t "mytopic" -m "Hello World" -q 1
```
Параметры следующие:

-h — Адрес сервера

-t —  Название топика, в котором публикуется сообщение (в данном примере это mytopic)

-m — Текст сообщения

-q — Качество обслуживания

В результате, вы увидите в окне с подпиской текст «Hello World»

4.1.4. Графические клиенты
----------
### Расширение для браузера MQTTLens
Простой способ проверить работу сервера и увидеть вывод прямо в браузере — установить расширение MQTTLens для браузера Chrome. Установите его на своем компьютере.
Войдите в расширение и добавьте новое соединение. Для подключения к серверу достаточно знать IP-адрес, порт, логин и пароль. Hostname — введите IP-адрес компьютера, где запущен сервер, порт — 1883, и логин с паролем. Хостом может быть как локальный, так и удаленный сервер.
![2](https://lh3.googleusercontent.com/3c5FXpvFhFNgHeRtHfci8Cwbu9Mp2zrIWXC8RKWbv4SZ_6_EB0HGlgDAnc9bx-99a7DMzYaxCFpZs9coMcm3nRcJCyJC8lWZjiSIRWMnkJ2W7UOvMo8391nY4jj2kB8CtHp1uKjX)

Попробуйте посмотреть в этом расширении вывод сообщений MQTT:
![3](https://lh4.googleusercontent.com/zILQmJEkshHKBzhpCD6EOZE2Sqe7aV5rGBri-Cg029IuhKjJXZliaZJgvfSF4gzLKDJKR1Yz3TBc4ojAhruXWbVSq1Vg6a7NVB2j45-akO50-VTvEuQtBR4cNicIRxNNj7CMk3he)
### MQTT.fx
Есть программа и с более широким функционалом. Она называется MQTT.fx и в ряде случаев незаменима. Программа написана на Java, её интерфейс довольно приятен.
Ознакомьтесь с ней самостоятельно. Принцип работы схож с MQTTLens. Благодаря большому набору различных опций, эта программа может выручить и помочь найти проблему в сложной ситуации - например, когда не получается подключиться к внешнему MQTT-серверу, используя сторонние библиотеки (о них далее).
![3](https://lh3.googleusercontent.com/3AqxeuQLYd58POEtK5zc7ypvRYlSO4z1fP-KiosUeul90aLeBgfAbzC2Lkbdkq8P4ROZcwic36d1I6w65c81Cydb2-_fJxwMR7_qXTfHtmB7ESRDFfqdrjIZD_N8pfRY184sAnNs)

